# 智能路由管理工具技术设计文档

## 📋 项目概述

本文档详细描述了基于Go技术栈的智能路由管理工具的技术实现设计，用于解决WireGuard VPN环境下中国大陆IP地址的智能分流问题。该工具采用事件驱动架构，实现了真正的实时网络监控和VPN状态检测。

## 🏗️ 整体架构设计

### 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    Smart Route Manager                      │
├─────────────────────────────────────────────────────────────┤
│  CLI Interface (cobra)                                      │
├─────────────────────────────────────────────────────────────┤
│  Config Manager    │  Route Switch     │  Network Monitor   │
│  - IP段文件解析    │  - 统一路由切换   │  - 双重状态监控    │
│  - DNS服务器配置   │  - 批量路由操作   │  - VPN状态检测     │
│  - 配置文件管理    │  - 事务性重置     │  - 物理网关检测    │
├─────────────────────────────────────────────────────────────┤
│  Service Manager                                            │
│  - 事件处理循环     │  - 信号处理       │  - 生命周期管理   │
├─────────────────────────────────────────────────────────────┤
│  Route Manager (Platform Specific)                         │
│  - BSD Route Socket (macOS)  │  - 物理网关获取              │
│  - WinAPI (Windows)           │  - 当前路由获取              │
│  - Netlink (Linux)            │  - 批量路由操作              │
└─────────────────────────────────────────────────────────────┘
```

## 🔄 事件驱动监控链条

### 完整的网络事件处理流程

系统采用真正的事件驱动架构，实现毫秒级的网络变化响应：

```
系统路由变化事件
    ↓ (AF_ROUTE socket / Netlink / WinAPI)
Route Socket 实时监控
    ↓ (parseRouteMessage 限频处理)
双重状态检查机制
    ├── 物理网关检测 (GetDefaultGateway)
    │   └── WiFi网络切换检测
    └── VPN状态检测 (GetCurrentDefaultRoute)  
        └── TUN接口状态检测
    ↓ (NetworkEvent 生成)
事件通道传递 (eventChan)
    ↓ (ServiceManager.serviceLoop)
事件类型处理分发
    ├── GatewayChanged (物理网关变化)
    ├── VPNConnected (VPN连接)
    └── VPNDisconnected (VPN断开)
    ↓ (handleNetworkEvent)
统一路由重置逻辑
    ↓ (RouteSwitch.SetupRoutes)
批量路由操作执行
    └── 完整路由重建 (清理 + 设置)
```

### 关键设计特点

#### 1. 双重检测机制
- **物理网关监控**: 专门检测WiFi网络切换，使用`getPhysicalGateway()`确保获取到真实的物理网络接口
- **VPN状态监控**: 检测默认路由指向，使用`GetCurrentDefaultRoute()`获取系统实际的默认路由
- **独立状态跟踪**: 两种状态变化互不干扰，可以同时处理复杂的网络场景

#### 2. 事件驱动优势  
- **真实实时性**: 基于操作系统原生路由事件，响应延迟 < 100ms
- **零轮询开销**: 完全基于事件通知，不消耗CPU在空闲状态检查
- **智能限频**: 200ms窗口内合并多个路由事件，避免事件风暴

#### 3. 统一路由处理
- **事务性操作**: 每次网络变化都执行完整的"清理-重建"流程
- **原子性保证**: 确保路由状态的一致性，避免部分失败导致的中间状态
- **批量优化**: 3000+条路由规则在3-4秒内完成切换

## 🔧 核心模块设计

### 1. Network Monitor (网络监控器)

#### 职责
- **实时事件监控**: 基于操作系统原生路由套接字监听系统路由变化
- **双重状态检测**: 同时跟踪物理网关状态和VPN连接状态  
- **智能事件生成**: 根据不同的状态变化生成相应的网络事件
- **故障降级处理**: 当route socket失效时自动启用轮询备用方案

#### 关键特性
- **真正事件驱动**: 使用AF_ROUTE socket (BSD)、Netlink (Linux) 等系统级事件接口
- **VPN接口识别**: 通过接口名模式匹配识别TUN/TAP等VPN接口
- **限频机制**: 200ms窗口合并路由事件，避免事件风暴
- **健康监控**: 自动检测route socket状态，必要时启用轮询

### 2. Route Manager (路由管理器)

#### 职责  
- **双重网关获取**: 分别提供物理网关和当前默认路由获取能力
- **批量路由操作**: 支持高效的并发路由增删操作
- **跨平台抽象**: 统一的路由操作接口，支持BSD/Linux/Windows
- **错误处理**: 完善的重试机制和错误分类处理

#### 设计特点
- **GetDefaultGateway()**: 专门获取物理网络接口，用于路由管理
- **GetCurrentDefaultRoute()**: 获取系统真实默认路由，用于VPN检测
- **平台特化**: 每个平台都有优化的实现方式
- **批量优化**: 支持并发路由操作以提升性能

### 3. Route Switch (路由切换器)

#### 职责
- **统一路由切换逻辑**: 提供一致的路由重置流程
- **事务性操作**: 确保路由切换的原子性，避免中间状态
- **完整重建**: 每次变化都执行"清理-重建"流程，保证状态一致性
- **批量优化**: 通过并发处理提升大量路由操作的性能

#### 设计特点
- **清理优先**: 首先删除所有管理的路由，避免冲突
- **批量重建**: 基于新网关批量添加所有中国路由规则
- **错误恢复**: 操作失败时提供回滚机制

### 4. Service Manager (服务管理器)

#### 职责
- **事件处理循环**: 监听并处理来自NetworkMonitor的事件
- **生命周期管理**: 管理整个服务的启动、运行和关闭流程
- **信号处理**: 响应系统信号实现优雅关闭
- **权限管理**: 确保以正确权限运行路由操作

#### 核心流程
- **事件分发**: 根据事件类型(GatewayChanged/VPNConnected/VPNDisconnected)触发相应处理
- **状态同步**: 维护当前网关状态与路由状态的同步
- **错误处理**: 对路由操作失败进行恰当的错误处理和日志记录

## 🎯 路由管理策略

### 核心设计原则

系统采用**仅VPN环境下管理路由**的策略，确保路由管理的精准性和系统稳定性：

#### 1. VPN状态驱动的路由管理

- **VPN连接时**: 激活路由管理，使用物理网关为中国IP段设置专用路由
- **VPN断开时**: 清理所有管理的路由，恢复系统原始路由状态  
- **非VPN状态**: 不进行任何路由管理操作，保持系统路由表原始状态

#### 2. 网络变化处理策略

##### WiFi网络切换处理
- **VPN连接状态下的WiFi切换**:
  - 检测到物理网关变化(`GatewayChanged`事件)
  - 使用新的物理网关重新设置所有中国路由规则
  - 执行完整的路由重建流程(清理+重设)
  - 确保VPN流量继续通过新的物理网络出口

- **非VPN状态下的WiFi切换**:
  - 检测但不处理物理网关变化
  - 记录调试日志便于故障诊断
  - 不执行路由管理操作(因为此时无管理的路由需要更新)

##### VPN状态变化处理
- **VPN连接检测**(`VPNConnected`事件):
  - 获取当前物理网关信息
  - 为所有中国IP段和DNS服务器设置指向物理网关的路由
  - 建立完整的分流路由表

- **VPN断开检测**(`VPNDisconnected`事件):
  - 清理所有系统管理的路由规则
  - 不需要网关参数(gateway-independent操作)
  - 恢复系统默认路由行为

### 事件处理方法映射

#### handlePhysicalGatewayChange(物理网关变化)
- **触发条件**: WiFi网络切换且VPN处于连接状态
- **处理逻辑**: 使用新物理网关重新设置所有路由
- **参数**: `newGW net.IP` - 新的物理网关地址

#### handleVPNConnection(VPN连接)  
- **触发条件**: 检测到VPN接口激活(如utun、tun等)
- **处理逻辑**: 基于物理网关建立完整分流路由
- **参数**: `physicalGW net.IP` - 用于路由设置的物理网关

#### handleVPNDisconnection(VPN断开)
- **触发条件**: VPN接口消失，默认路由回归物理接口
- **处理逻辑**: 清理所有管理的路由，无需网关信息
- **参数**: 无参数(gateway-independent清理操作)

### 启动时的VPN状态检查

#### setupInitialRoutes(初始路由设置)
- **设计原则**: 启动时遵循与运行时相同的"仅VPN环境下管理路由"策略
- **检查逻辑**: 
  - 获取当前系统默认路由信息(`GetCurrentDefaultRoute`)
  - 通过接口名模式匹配检测VPN连接状态
  - 支持常见VPN接口：utun、tun、tap、ppp等
- **处理策略**:
  - **VPN已连接**: 使用物理网关设置完整的中国路由表
  - **VPN未连接**: 跳过路由设置，记录跳过原因
- **日志记录**: 详细记录VPN状态检测结果和路由设置决策过程

#### 一致性保证
- **daemon模式**: 启动时检查VPN状态，只在VPN连接时设置路由
- **一次性模式**: 同样检查VPN状态，确保行为一致性
- **避免无效操作**: 防止在非VPN环境下设置无意义的路由规则
- **状态同步**: 确保启动状态与运行时事件处理逻辑完全一致

## 🚀 性能优化策略

### 1. 并发处理优化

#### 批量操作策略
- **Goroutine池**: 使用固定大小的工作池控制并发数量（默认：50个goroutine）
- **批次处理**: 将3000+条路由按批次处理（默认批次大小：100条）
- **退避重试**: 实现指数退避重试机制处理临时失败
- **信号量控制**: 通过信号量避免过多并发导致的系统资源耗尽

### 2. 内存优化

#### 对象复用策略
- **内存池**: 使用sync.Pool复用路由消息缓冲区，减少GC压力
- **预分配**: 基于预估容量预分配切片和映射，避免动态扩展开销
- **零拷贝**: 在可能的情况下使用零拷贝技术减少内存分配

### 3. 系统调用优化

#### 批量处理机制
- **消息合并**: 将多个路由操作合并为单次系统调用
- **缓冲优化**: 使用合适大小的缓冲区减少系统调用次数
- **非阻塞IO**: 在支持的平台上使用非阻塞IO提升响应性

## 🔒 错误处理与可靠性

### 1. 错误分类与处理

#### 分层错误处理
- **权限错误**: 检测root权限，提供明确的权限提示
- **网络错误**: 区分临时网络问题和永久性错误
- **路由冲突**: 处理路由表中的冲突和重复条目
- **系统调用错误**: 平台特定的系统调用错误处理
- **超时错误**: 对长时间运行的操作设置合理超时

### 2. 重试机制

#### 智能重试策略
- **错误分类**: 只对可恢复错误进行重试
- **指数退避**: 使用指数退避避免重试风暴
- **最大重试**: 设置合理的最大重试次数防止无限循环
- **快速失败**: 对不可恢复错误立即失败，不浪费时间

### 3. 事务性操作

#### 原子路由更新
- **回滚机制**: 操作失败时能够回滚到之前状态
- **分阶段执行**: 将复杂操作分为多个原子阶段
- **状态一致性**: 确保任何时刻路由状态都是一致的
- **故障恢复**: 从部分失败中恢复并继续执行

## 📊 监控与日志

### 1. 性能指标收集

#### 关键指标
- **路由操作统计**: 记录成功/失败的路由操作数量和耗时
- **网络变化频率**: 监控网络状态变化的频率和模式
- **事件处理延迟**: 从检测到处理完成的端到端延迟
- **资源使用情况**: 内存占用、CPU使用率等系统资源指标
- **健康状态**: Route socket连接状态、轮询降级状态等

### 2. 结构化日志

#### 日志策略
- **分级日志**: 支持DEBUG、INFO、WARN、ERROR等多个级别
- **结构化输出**: 使用JSON格式便于日志分析和处理
- **上下文信息**: 包含完整的操作上下文，便于问题诊断
- **静默模式**: 支持静默运行模式，减少生产环境日志噪音

## 🔧 部署与配置

### 1. 配置管理

#### 配置文件结构
- **基本配置**: 日志级别、运行模式、静默选项
- **文件路径**: 中国IP段文件和DNS服务器文件路径
- **网络参数**: 监控间隔、重试次数、超时设置
- **性能调优**: 并发限制、批次大小等性能参数

### 2. 系统服务集成

#### 跨平台服务支持
- **macOS**: 基于launchd的系统服务集成
- **Linux**: 基于systemd的服务管理
- **Windows**: 基于Windows Service的服务支持
- **自动启动**: 支持系统启动时自动启动服务

### 3. 安装与部署

#### 自动化部署
- **权限检查**: 确保安装过程具有正确的系统权限
- **文件部署**: 自动复制配置文件和二进制文件到系统目录
- **服务注册**: 根据平台自动注册和启动系统服务
- **配置验证**: 安装后验证配置文件和服务状态

## 📈 性能预期与系统特性

### 性能指标

基于事件驱动架构的优化设计，系统预期性能：

- **路由设置速度**: 3000条路由规则在3-4秒内完成
- **内存占用**: 运行时稳定在40-60MB
- **CPU使用率**: 正常监控状态下 < 2%
- **事件响应延迟**: < 100ms检测网络变化并开始处理
- **并发处理能力**: 支持50个并发路由操作
- **故障恢复时间**: < 10秒完成自动故障恢复

### 系统特性

#### 可靠性特性
- **事务性路由更新**: 确保路由状态一致性，避免中间状态
- **自动故障恢复**: Route socket失效时自动降级到轮询模式
- **优雅关闭**: 响应系统信号，正确清理资源和状态

#### 可观测性特性
- **实时监控**: 提供详细的系统状态和性能指标
- **结构化日志**: 便于问题诊断和系统分析
- **健康检查**: 持续监控系统组件健康状态

#### 扩展性特性
- **跨平台支持**: 统一接口下的平台特化实现
- **配置驱动**: 通过配置文件灵活调整系统行为
- **模块化设计**: 松耦合的组件设计，便于维护和扩展

此设计通过真正的事件驱动架构，实现了高性能、高可靠性和良好的可维护性，满足了复杂网络环境下的智能路由管理需求。