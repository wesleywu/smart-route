# # 智能路由管理工具需求文档

## 📋 项目概述

### 背景
在使用 WireGuard VPN 时，系统会将所有网络流量路由到 VPN 隧道接口（通常是 `utun6`），而原始的默认网卡（如 `en0`）的网关信息虽然保留但不再作为默认路由使用。这会导致：

1. **访问中国大陆网站速度慢**：国内流量绕道国外服务器
2. **不必要的国际带宽消耗**：本地可直达的服务通过VPN转发
3. **DNS解析延迟**：国内DNS服务器通过VPN访问效率低下

### 目标
开发一个高性能的智能路由管理工具，实现中国大陆IP地址和DNS服务器的流量分流，让这些流量直接通过本地网关访问，而其他流量继续走VPN通道。

## 🎯 核心需求

### 功能需求

#### FR-001：网关信息获取
- **需求描述**：程序能够准确获取缺省网卡（通常是 `en0`）的原始默认网关地址
- **输入**：系统路由表信息
- **输出**：en0网卡对应的网关IP地址（如：`192.168.34.1`）
- **实现方式**：解析 `netstat -rn` 输出或使用系统API或者 Go Native 的方法

#### FR-002：中国IP路由规则管理
- **需求描述**：基于中国IP地址段列表，批量设置路由规则
- **输入**：
  - 中国IP地址段文件 (`chnroute.txt`)
  - 目标网关地址
- **输出**：系统路由表中的对应路由规则
- **规则格式**：`route add -net [IP段] [网关]`或者 Go Native 的方法

#### FR-003：DNS服务器路由规则
- **需求描述**：为常用的中国DNS服务器设置直连路由
- **输入**：
  - 中国DNS服务器文件 (`chdns.txt`)
- **规则格式**：`route add [DNS_IP] [网关]`或者 Go Native 的方法

#### FR-004：网络变化实时监控 ⭐
- **需求描述**：持续监控网络状态变化，自动触发路由规则更新
- **监控目标**：
  - WiFi连接状态变化
  - 网络接口UP/DOWN状态
  - 默认网关地址变化
  - IP地址分配变化
- **触发条件**：
  - WiFi热点切换
  - 网络重新连接
  - DHCP续约导致的网关变化
  - 手动网络配置修改

#### FR-005：智能路由清理与重建
- **需求描述**：检测到网关变化时，自动清理旧路由规则并设置新规则
- **处理流程**：
  1. 检测当前网关与缓存网关是否一致
  2. 如不一致，使用旧网关地址清理现有路由规则
  3. 使用新网关地址重建所有路由规则
  4. 更新网关缓存

#### FR-006：高性能路由操作
- **需求描述**：能够快速处理3000+条路由规则
- **性能目标**：
  - 路由规则设置时间 < 5秒
  - 支持并发操作
  - 内存占用 < 100MB
- **实现方式**：使用Go语言原生系统调用，避免进程创建开销

#### FR-007：支持作为系统服务运行
- **需求描述**：支持作为系统服务运行，开机自启动
- **实现方式**：本工具支持作为一个 daemon 长期运行，并支持通过 `launchd` 或者 `systemd` 等系统服务管理工具管理

### 非功能性需求

#### NFR-001：性能要求
- **路由设置速度**：3000+条路由规则在5秒内完成
- **内存使用**：运行时内存占用不超过100MB
- **CPU使用**：正常运行时CPU占用率 < 5%
- **监控响应时间**：网络变化检测延迟 < 3秒

#### NFR-002：稳定性要求
- **错误恢复**：路由设置失败时能够自动重试
- **异常处理**：网络异常时程序不崩溃，能够恢复运行
- **资源清理**：程序退出时正确关闭所有系统资源

#### NFR-003：可用性要求
- **系统权限**：需要root/sudo权限操作系统路由表
- **平台支持**：支持macOS系统（基于BSD路由系统）和 Windows 系统
- **兼容性**：与WireGuard、其他VPN软件兼容

#### NFR-004：维护性要求
- **日志记录**：提供详细的操作日志和错误信息
- **静默模式**：支持静默运行模式，减少输出信息

## 🚀 使用场景

### 场景一：首次部署
1. 用户安装WireGuard并连接
2. 运行工具进行初始路由设置
3. 验证中国网站访问速度提升

### 场景二：WiFi热点切换
1. 用户从家庭WiFi切换到办公室WiFi
2. 工具自动检测到网关变化（192.168.1.1 → 10.0.0.1）
3. 自动清理旧路由规则并设置新规则
4. 用户无感知完成切换

### 场景三：网络异常恢复
1. 网络临时中断后恢复
2. DHCP重新分配IP和网关
3. 工具检测到变化并自动调整路由
4. 服务持续可用

### 场景四：长期运行监控
1. 工具以daemon模式运行
2. 持续监控网络状态
3. 定期验证路由规则有效性
4. 异常时自动修复

## 🔧 技术实现要求

### 开发语言
- **主语言**：Go 1.24+
- **系统调用**：使用`golang.org/x/sys/unix`包
- **网络操作**：原生PF_ROUTE socket


