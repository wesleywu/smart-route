# ğŸ§  æ™ºèƒ½ç½‘å…³ç®¡ç†ç³»ç»Ÿ

## âœ¨ æ–°åŠŸèƒ½äº®ç‚¹

åŸºäºä½ çš„å»ºè®®ï¼Œæˆ‘ä»¬å®ç°äº†æ™ºèƒ½ç½‘å…³çŠ¶æ€ç®¡ç†ç³»ç»Ÿï¼Œå®Œç¾è§£å†³äº†WiFiåˆ‡æ¢æ—¶çš„è·¯ç”±å†²çªé—®é¢˜ï¼

## ğŸ¯ è§£å†³çš„æ ¸å¿ƒé—®é¢˜

### é—®é¢˜åœºæ™¯
1. **WiFi A**: ç½‘å…³ `192.168.32.1` â†’ è®¾ç½®8694æ¡ä¸­å›½è·¯ç”±
2. **åˆ‡æ¢åˆ°WiFi B**: ç½‘å…³å˜ä¸º `192.168.1.1`
3. **é—®é¢˜**: æ—§çš„8694æ¡è·¯ç”±è¿˜æŒ‡å‘ `192.168.32.1`ï¼Œå¯¼è‡´å›½å†…ç½‘ç»œä¸é€š

### æ™ºèƒ½è§£å†³æ–¹æ¡ˆ
ç¨‹åºç°åœ¨ä¼šï¼š
1. **è®°ä½**ä¹‹å‰è®¾ç½®çš„ç½‘å…³
2. **æ£€æµ‹**ç½‘å…³æ˜¯å¦å˜åŒ–
3. **ç²¾ç¡®æ¸…ç†**æ—§ç½‘å…³çš„è·¯ç”±
4. **è®¾ç½®**æ–°ç½‘å…³çš„è·¯ç”±
5. **ä¿å­˜**æ–°çŠ¶æ€ä¾›ä¸‹æ¬¡ä½¿ç”¨

## ğŸ”§ æŠ€æœ¯å®ç°

### ç½‘å…³çŠ¶æ€æ–‡ä»¶
ä½ç½®: `/tmp/smartroute_gateway_state.json`

```json
{
  "previous_gateway": "192.168.32.1",
  "previous_interface": "en0", 
  "last_update": "2025-08-25T10:45:00+08:00",
  "route_count": 8694
}
```

### æ™ºèƒ½æ£€æµ‹é€»è¾‘

```bash
å¯åŠ¨æ—¶ â†’ åŠ è½½çŠ¶æ€æ–‡ä»¶ â†’ æ¯”è¾ƒç½‘å…³ â†’ æ‰§è¡Œç›¸åº”åŠ¨ä½œ
```

#### åœºæ™¯1: é¦–æ¬¡è¿è¡Œ
```
[INFO] First time setup, gateway=192.168.32.1, interface=en0
[INFO] Setting up routes, total=8694
[INFO] Gateway state saved
```

#### åœºæ™¯2: ç½‘å…³æœªå˜åŒ–
```
[INFO] Gateway unchanged, gateway=192.168.32.1
[INFO] Cleaning up existing routes for consistency...
[INFO] Setting up routes, total=8694
```

#### åœºæ™¯3: ç½‘å…³å·²å˜åŒ– â­
```
[INFO] Gateway change detected
       previous_gateway=192.168.32.1
       current_gateway=192.168.1.1
[INFO] Cleaning up routes for previous gateway=192.168.32.1
[INFO] Successfully cleaned routes, count=8694
[INFO] Setting up routes, gateway=192.168.1.1, total=8694
[INFO] Gateway state saved
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ä½¿ç”¨ï¼ˆæ¨èï¼‰
```bash
# æ™ºèƒ½è®¾ç½®è·¯ç”±ï¼ˆè‡ªåŠ¨å¤„ç†ç½‘å…³å˜åŒ–ï¼‰
sudo ./smartroute
```

### å®ˆæŠ¤è¿›ç¨‹æ¨¡å¼ï¼ˆå…¨è‡ªåŠ¨ï¼‰
```bash
# å¯åŠ¨å®ˆæŠ¤è¿›ç¨‹ï¼Œè‡ªåŠ¨ç›‘æ§ç½‘ç»œå˜åŒ–
sudo ./smartroute daemon
```

### æµ‹è¯•ç½‘å…³ç®¡ç†
```bash
# æŸ¥çœ‹ç½‘å…³ç®¡ç†æ¼”ç¤º
sudo ./test-gateway-management.sh
```

## ğŸ“Š ä¼˜åŠ¿å¯¹æ¯”

### ä¹‹å‰çš„æ–¹å¼ âŒ
```bash
# åˆ‡æ¢WiFiåéœ€è¦æ‰‹åŠ¨æ¸…ç†
sudo ./cleanup-routes.sh    # æ¸…ç†æ‰€æœ‰æ—§è·¯ç”±
sudo ./smartroute          # é‡æ–°è®¾ç½®
```

### ç°åœ¨çš„æ™ºèƒ½æ–¹å¼ âœ…
```bash
# åˆ‡æ¢WiFiåç›´æ¥è¿è¡Œï¼Œè‡ªåŠ¨å¤„ç†ä¸€åˆ‡
sudo ./smartroute          # è‡ªåŠ¨æ£€æµ‹+æ¸…ç†+è®¾ç½®
```

## ğŸ¯ å®é™…åœºæ™¯æ¼”ç¤º

### åœºæ™¯1: å®¶åº­åŠå…¬åˆ‡æ¢
```bash
# åœ¨å®¶ (WiFi: 192.168.1.1)
sudo ./smartroute
# â†’ è®¾ç½®8694æ¡è·¯ç”±æŒ‡å‘192.168.1.1

# åˆ°åŠå…¬å®¤ (WiFi: 10.0.0.1)  
sudo ./smartroute
# â†’ è‡ªåŠ¨æ¸…ç†192.168.1.1çš„8694æ¡è·¯ç”±
# â†’ è®¾ç½®8694æ¡æ–°è·¯ç”±æŒ‡å‘10.0.0.1
```

### åœºæ™¯2: å’–å•¡å…å·¥ä½œ
```bash
# ä»åŠå…¬å®¤åˆ°å’–å•¡å… (WiFi: 192.168.100.1)
sudo ./smartroute
# â†’ æ£€æµ‹åˆ°ç½‘å…³ä»10.0.0.1å˜ä¸º192.168.100.1
# â†’ è‡ªåŠ¨æ¸…ç†+é‡æ–°è®¾ç½®ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„
```

## ğŸ” éªŒè¯æ•ˆæœ

### æ£€æŸ¥ç½‘å…³çŠ¶æ€
```bash
./smartroute version
# è¾“å‡º: Current Gateway: 192.168.1.1 (en0)
```

### æŸ¥çœ‹çŠ¶æ€æ–‡ä»¶
```bash
cat /tmp/smartroute_gateway_state.json
```

### éªŒè¯è·¯ç”±è®¾ç½®
```bash
# æ£€æŸ¥ä¸­å›½IPè·¯ç”±
route -n get 223.5.5.5
# åº”è¯¥æ˜¾ç¤ºå½“å‰æ­£ç¡®çš„ç½‘å…³

# ç»Ÿè®¡è·¯ç”±æ•°é‡
netstat -rn | grep "ä½ çš„ç½‘å…³IP" | wc -l
# åº”è¯¥æ˜¾ç¤ºçº¦8694æ¡
```

## ğŸ’¡ æ™ºèƒ½ç‰¹æ€§

1. **é›¶é…ç½®**: æ— éœ€ä¿®æ”¹é…ç½®ï¼Œè‡ªåŠ¨æ£€æµ‹å¤„ç†
2. **ç²¾ç¡®æ¸…ç†**: åªæ¸…ç†éœ€è¦æ¸…ç†çš„è·¯ç”±ï¼Œä¸å½±å“å…¶ä»–
3. **çŠ¶æ€æŒä¹…**: è®°å½•çŠ¶æ€ï¼Œä¸‹æ¬¡å¯åŠ¨æ—¶æ™ºèƒ½åˆ¤æ–­
4. **é”™è¯¯å®¹å¿**: æ¸…ç†å¤±è´¥ä¸å½±å“æ–°è·¯ç”±è®¾ç½®
5. **æ—¥å¿—è¯¦ç»†**: æ¸…æ™°æ˜¾ç¤ºæ¯ä¸ªæ­¥éª¤çš„æ“ä½œ

## ğŸš¨ æ³¨æ„äº‹é¡¹

1. **çŠ¶æ€æ–‡ä»¶ä½ç½®**: `/tmp/smartroute_gateway_state.json`
2. **æƒé™è¦æ±‚**: ä»éœ€è¦rootæƒé™æ“ä½œè·¯ç”±
3. **å…¼å®¹æ€§**: ä¸å®ˆæŠ¤è¿›ç¨‹æ¨¡å¼å®Œå…¨å…¼å®¹
4. **å¤‡ä»½**: çŠ¶æ€æ–‡ä»¶è‡ªåŠ¨ç»´æŠ¤ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„

## ğŸ‰ æ€»ç»“

ç°åœ¨ä½ å¯ä»¥ï¼š
- âœ… **éšæ„åˆ‡æ¢WiFi**ï¼Œç¨‹åºè‡ªåŠ¨å¤„ç†è·¯ç”±æ›´æ–°
- âœ… **æ— éœ€æ‰‹åŠ¨æ¸…ç†**ï¼Œæ™ºèƒ½æ£€æµ‹ç½‘å…³å˜åŒ–
- âœ… **ä¸€æ¡å‘½ä»¤æå®š**ï¼Œ`sudo ./smartroute` å¤„ç†ä¸€åˆ‡
- âœ… **å®Œç¾åˆ†æµä½“éªŒ**ï¼Œå›½å†…ç›´è¿ï¼Œå›½å¤–èµ°VPN

è¿™ä¸ªæ™ºèƒ½ç½‘å…³ç®¡ç†ç³»ç»Ÿè®©ç½‘ç»œåˆ†æµå˜å¾—çœŸæ­£"æ™ºèƒ½"å’Œ"æ— æ„Ÿ"ï¼ğŸš€